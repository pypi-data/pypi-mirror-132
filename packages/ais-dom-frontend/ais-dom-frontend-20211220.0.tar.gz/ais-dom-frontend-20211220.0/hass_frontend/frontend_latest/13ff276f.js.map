{"version":3,"file":"13ff276f.js","mappings":";AA0FA;AAGA;;AAUA;AACA;;;;AAIA;;;;;;;;;;;;;AAiEA;;;;;;;;;;;;;AAmBA;AAaA;;;;;;;;;;;;;AAeA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA/LA","sources":["webpack://home-assistant-frontend/./src/panels/developer-tools/statistics/developer-tools-statistics.ts"],"sourcesContent":["import \"@material/mwc-button/mwc-button\";\nimport { HassEntity } from \"home-assistant-js-websocket\";\nimport { css, CSSResultGroup, html, LitElement } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators\";\nimport memoizeOne from \"memoize-one\";\nimport { fireEvent } from \"../../../common/dom/fire_event\";\nimport { computeStateName } from \"../../../common/entity/compute_state_name\";\nimport \"../../../components/data-table/ha-data-table\";\nimport type { DataTableColumnContainer } from \"../../../components/data-table/ha-data-table\";\nimport {\n  getStatisticIds,\n  StatisticsMetaData,\n  StatisticsValidationResult,\n  validateStatistics,\n} from \"../../../data/history\";\nimport { showAlertDialog } from \"../../../dialogs/generic/show-dialog-box\";\nimport { haStyle } from \"../../../resources/styles\";\nimport { HomeAssistant } from \"../../../types\";\nimport { showFixStatisticsUnitsChangedDialog } from \"./show-dialog-statistics-fix-units-changed\";\nimport { showFixStatisticsUnsupportedUnitMetadataDialog } from \"./show-dialog-statistics-fix-unsupported-unit-meta\";\n\nconst FIX_ISSUES_ORDER = {\n  entity_not_recorded: 1,\n  unsupported_unit_state: 2,\n  unsupported_state_class: 3,\n  units_changed: 4,\n  unsupported_unit_metadata: 5,\n};\n@customElement(\"developer-tools-statistics\")\nclass HaPanelDevStatistics extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property({ type: Boolean }) public narrow!: boolean;\n\n  @state() private _data: (StatisticsMetaData & {\n    issues?: StatisticsValidationResult[];\n    state?: HassEntity;\n  })[] = [] as StatisticsMetaData[];\n\n  protected firstUpdated() {\n    this._validateStatistics();\n  }\n\n  private _columns = memoizeOne(\n    (localize): DataTableColumnContainer => ({\n      state: {\n        title: \"Entity\",\n        sortable: true,\n        filterable: true,\n        grows: true,\n        template: (entityState, data: any) =>\n          html`${entityState\n            ? computeStateName(entityState)\n            : data.statistic_id}`,\n      },\n      statistic_id: {\n        title: \"Statistic id\",\n        sortable: true,\n        filterable: true,\n        hidden: this.narrow,\n        width: \"30%\",\n      },\n      unit_of_measurement: {\n        title: \"Unit\",\n        sortable: true,\n        filterable: true,\n        width: \"10%\",\n      },\n      issues: {\n        title: \"Issue\",\n        sortable: true,\n        filterable: true,\n        direction: \"asc\",\n        width: \"30%\",\n        template: (issues) =>\n          html`${issues\n            ? issues.map(\n                (issue) =>\n                  localize(\n                    `ui.panel.developer-tools.tabs.statistics.issues.${issue.type}`,\n                    issue.data\n                  ) || issue.type\n              )\n            : localize(\"ui.panel.developer-tools.tabs.statistics.no_issue\")}`,\n      },\n      fix: {\n        title: \"\",\n        template: (_, data: any) =>\n          html`${data.issues\n            ? html`<mwc-button @click=${this._fixIssue} .data=${data.issues}>\n                ${localize(\n                  \"ui.panel.developer-tools.tabs.statistics.fix_issue.fix\"\n                )}\n              </mwc-button>`\n            : \"\"}`,\n        width: \"113px\",\n      },\n    })\n  );\n\n  protected render() {\n    return html`\n      <ha-data-table\n        .columns=${this._columns(this.hass.localize)}\n        .data=${this._data}\n        noDataText=\"No issues found!\"\n        id=\"statistic_id\"\n        clickable\n        @row-click=${this._rowClicked}\n      ></ha-data-table>\n    `;\n  }\n\n  private _rowClicked(ev) {\n    const id = ev.detail.id;\n    if (id in this.hass.states) {\n      fireEvent(this, \"hass-more-info\", { entityId: id });\n    }\n  }\n\n  private async _validateStatistics() {\n    const [statisticIds, issues] = await Promise.all([\n      getStatisticIds(this.hass),\n      validateStatistics(this.hass),\n    ]);\n\n    const statsIds = new Set();\n\n    this._data = statisticIds.map((statistic) => {\n      statsIds.add(statistic.statistic_id);\n      return {\n        ...statistic,\n        state: this.hass.states[statistic.statistic_id],\n        issues: issues[statistic.statistic_id],\n      };\n    });\n\n    Object.keys(issues).forEach((statisticId) => {\n      if (!statsIds.has(statisticId)) {\n        this._data.push({\n          statistic_id: statisticId,\n          unit_of_measurement: \"\",\n          state: this.hass.states[statisticId],\n          issues: issues[statisticId],\n        });\n      }\n    });\n  }\n\n  private _fixIssue = (ev) => {\n    const issues = (ev.currentTarget.data as StatisticsValidationResult[]).sort(\n      (itemA, itemB) =>\n        (FIX_ISSUES_ORDER[itemA.type] ?? 99) -\n        (FIX_ISSUES_ORDER[itemB.type] ?? 99)\n    );\n    const issue = issues[0];\n    switch (issue.type) {\n      case \"entity_not_recorded\":\n        showAlertDialog(this, {\n          title: \"Entity not recorded\",\n          text: html`State changes of this entity are not recorded, therefore,\n            we can not track long term statistics for it. <br /><br />You\n            probably excluded this entity, or have just included some\n            entities.<br /><br />See the\n            <a\n              href=\"https://www.home-assistant.io/integrations/recorder/#configure-filter\"\n              target=\"_blank\"\n              rel=\"noreferrer noopener\"\n            >\n              recorder documentation</a\n            >\n            for more information.`,\n        });\n        break;\n      case \"unsupported_state_class\":\n        showAlertDialog(this, {\n          title: \"Unsupported state class\",\n          text: html`The state class of this entity, ${issue.data.state_class}\n            is not supported. <br />Statistics can not be generated until this\n            entity has a supported state class.<br /><br />If this state class\n            was provided by an integration, this is a bug. Please report an\n            issue.<br /><br />If you have set this state class yourself, please\n            correct it. The different state classes and when to use which can be\n            found in the\n            <a\n              href=\"https://developers.home-assistant.io/docs/core/entity/sensor/#long-term-statistics\"\n              target=\"_blank\"\n              rel=\"noreferrer noopener\"\n            >\n              developer documentation</a\n            >.`,\n        });\n        break;\n      case \"unsupported_unit_metadata\":\n        showFixStatisticsUnsupportedUnitMetadataDialog(this, {\n          issue,\n          fixedCallback: () => {\n            this._validateStatistics();\n          },\n        });\n        break;\n      case \"unsupported_unit_state\":\n        showAlertDialog(this, {\n          title: \"Unsupported unit\",\n          text: html`The unit of your entity is not a supported unit for the\n            device class of the entity, ${issue.data.device_class}.\n            <br />Statistics can not be generated until this entity has a\n            supported unit.<br /><br />If this unit was provided by an\n            integration, this is a bug. Please report an issue.<br /><br />If\n            you have set this unit yourself, and want to have statistics\n            generated, make sure the unit matches the device class. The\n            supported units are documented in the\n            <a\n              href=\"https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes\"\n              target=\"_blank\"\n              rel=\"noreferrer noopener\"\n            >\n              developer documentation</a\n            >.`,\n        });\n        break;\n      case \"units_changed\":\n        showFixStatisticsUnitsChangedDialog(this, {\n          issue,\n          fixedCallback: () => {\n            this._validateStatistics();\n          },\n        });\n        break;\n      default:\n        showAlertDialog(this, {\n          title: \"Fix issue\",\n          text: \"Fixing this issue is not supported yet.\",\n        });\n    }\n  };\n\n  static get styles(): CSSResultGroup {\n    return [\n      haStyle,\n      css`\n        .content {\n          padding: 16px;\n        }\n\n        th {\n          padding: 0 8px;\n          text-align: left;\n          font-size: var(\n            --paper-input-container-shared-input-style_-_font-size\n          );\n        }\n\n        :host([rtl]) th {\n          text-align: right;\n        }\n\n        tr {\n          vertical-align: top;\n          direction: ltr;\n        }\n\n        tr:nth-child(odd) {\n          background-color: var(--table-row-background-color, #fff);\n        }\n\n        tr:nth-child(even) {\n          background-color: var(--table-row-alternative-background-color, #eee);\n        }\n        td {\n          padding: 4px;\n          min-width: 200px;\n          word-break: break-word;\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"developer-tools-statistics\": HaPanelDevStatistics;\n  }\n}\n"],"names":[],"sourceRoot":""}