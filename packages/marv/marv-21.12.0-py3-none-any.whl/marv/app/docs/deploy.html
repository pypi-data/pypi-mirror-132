<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deployment &mdash; MARV Robotics 21.12.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/sphinx_paramlinks.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon-32x32.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Access Control" href="accesscontrol.html" />
    <link rel="prev" title="Upload (EE)" href="upload.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MARV Robotics
          </a>
              <div class="version">
                21.12
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial/setup-basic-site.html">Tutorial: Setup basic site</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial/write-your-own.html">Tutorial: Write your own nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Patterns and known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="views.html">Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="scan.html">Scanner</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodes.html">Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="widgets.html">Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="httpapi.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="upload.html">Upload (EE)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#gunicorn-behind-nginx">Gunicorn behind NGINX</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#nginx-config">nginx config</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gunicorn-with-https">Gunicorn with HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-custom-ca-when-let-s-encrypt-is-unavailable">Use custom CA when Let’s Encrypt is unavailable</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="accesscontrol.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance.html">Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate/index.html">Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGES.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/marv.html">marv</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MARV Robotics</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Deployment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/deploy.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deployment">
<span id="deploy"></span><h1>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline"></a></h1>
<p>MARV’s frontend uses a service worker, which requires HTTPS for non-localhost access. You can either use a self-signed certificate or Let’s Encrypt. The latter only if your webserver is accessible from the internet.</p>
<p>For production usage we <strong>strongly recommend</strong> to use nginx as a reverse-proxy. The increased setup overhead is justified by greatly increased performance for serving large files.</p>
<p>Two deployments are described here in short:</p>
<ul class="simple">
<li><p>NGINX as a reverse proxy with a Let’s Encrypt certificate (recommended)</p></li>
<li><p>Gunicorn with a self-signed certificate (development only)</p></li>
</ul>
<section id="gunicorn-behind-nginx">
<span id="deploy-nginx"></span><h2>Gunicorn behind NGINX<a class="headerlink" href="#gunicorn-behind-nginx" title="Permalink to this headline"></a></h2>
<p>References:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://certbot.eff.org/all-instructions/">https://certbot.eff.org/all-instructions/</a></p></li>
<li><p><a class="reference external" href="https://aiohttp.readthedocs.io/en/stable/deployment.html#nginx-gunicorn">https://aiohttp.readthedocs.io/en/stable/deployment.html#nginx-gunicorn</a></p></li>
</ul>
<p>When working behind a reverse proxy MARV’s default Gunicorn config will work without change.</p>
<section id="nginx-config">
<h3>nginx config<a class="headerlink" href="#nginx-config" title="Permalink to this headline"></a></h3>
<p>Nginx allows marv to offload serving data from disk which is especially useful for large files. Adjust the paths of the nested internal location block to point to your store, within the docker container and outside of the docker container, under the assumption, that nginx is running directly on your host system. In case you are running marv in a virtual environment also directly on the host system, the paths are identical.</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
  <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
  <span class="kn">listen</span> <span class="s">[::]:80</span><span class="p">;</span>
  <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
  <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
  <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>
  <span class="kn">listen</span> <span class="s">[::]:443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>

  <span class="kn">include</span> <span class="s">/usr/lib/python3.7/site-packages/certbot_nginx/tls_configs/options-ssl-nginx.conf</span><span class="p">;</span>
  <span class="kn">ssl_stapling_verify</span> <span class="no">on</span><span class="p">;</span>
  <span class="kn">ssl_stapling</span> <span class="no">on</span><span class="p">;</span>

  <span class="kn">add_header</span> <span class="s">Strict-Transport-Security</span> <span class="s">&quot;max-age=63072000&quot;</span> <span class="s">always</span><span class="p">;</span>

  <span class="kn">ssl_trusted_certificate</span> <span class="s">/etc/letsencrypt/live/example.com/chain.pem</span><span class="p">;</span>
  <span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/example.com/privkey.pem</span><span class="p">;</span>
  <span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/example.com/fullchain.pem</span><span class="p">;</span>

  <span class="c1"># Docker setup running at the root</span>
  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="c1"># Attachments are EE-only, but the rule won&#39;t hurt CE</span>
    <span class="kn">location</span> <span class="s">/docker/container/path/to/attachments</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/host/path/to/attachments</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/docker/container/path/to/store</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/host/path/to/store</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/docker/container/path/to/leavesdir</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/host/path/to/leavesdir</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/docker/container/path/to/resources</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/host/path/to/resources</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/docker/container/path/to/scanroot</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/host/path/to/scanroot</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">client_max_body_size</span> <span class="mi">10m</span><span class="p">;</span>
    <span class="kn">client_body_buffer_size</span> <span class="mi">128k</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8000</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1"># Native installation running in different application root</span>

  <span class="kn">location</span> <span class="p">=</span> <span class="s">/approot</span> <span class="p">{</span>
    <span class="kn">rewrite</span> <span class="s">^(.*)</span>$ <span class="nv">$1/</span> <span class="s">redirect</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kn">location</span> <span class="s">/approot/</span> <span class="p">{</span>
    <span class="c1"># Attachments are EE-only, but the rule won&#39;t hurt CE</span>
    <span class="kn">location</span> <span class="s">/approot/path/to/attachments</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/path/to/attachments</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/approot/path/to/store</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/path/to/store</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/approot/path/to/leavesdir</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/path/to/leavesdir</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/approot/path/to/resources</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/path/to/resources</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/approot/path/to/scanroot</span> <span class="p">{</span>
      <span class="kn">internal</span><span class="p">;</span>
      <span class="kn">alias</span> <span class="s">/path/to/scanroot</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">client_max_body_size</span> <span class="mi">10m</span><span class="p">;</span>
    <span class="kn">client_body_buffer_size</span> <span class="mi">128k</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8001</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For a <strong>certificate signed by a custom CA</strong> (see steps below) point <code class="docutils literal notranslate"><span class="pre">ssl_trusted_certificate</span></code> to the CA certificate and adjust <code class="docutils literal notranslate"><span class="pre">ssl_certificate</span></code> and <code class="docutils literal notranslate"><span class="pre">ssl_certificate_key</span></code> to the generated files accordingly.</p>
</section>
</section>
<section id="gunicorn-with-https">
<span id="deploy-gunicorn"></span><h2>Gunicorn with HTTPS<a class="headerlink" href="#gunicorn-with-https" title="Permalink to this headline"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Use this mode of deployment for development setups only.</p>
</div>
<p>Gunicorn supports HTTPS out of the box with the limitation that it cannot serve HTTP and HTTPS simultaneously. To activate HTTPS mode you only need to provide Gunicorn with a certificate and corresponding keyfile. Use the <code class="docutils literal notranslate"><span class="pre">--keyfile</span></code> and <code class="docutils literal notranslate"><span class="pre">--certfile</span></code> options of MARV to enable the HTTPS mode. The following example makes MARV run on the default HTTPS port:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ marv serve --port 443 \
           --certfile /etc/letsencrypt/live/example.com/fullchain.pem \
           --keyfile /etc/letsencrypt/live/example.com/privkey.pem
</pre></div>
</div>
</section>
<section id="use-custom-ca-when-let-s-encrypt-is-unavailable">
<h2>Use custom CA when Let’s Encrypt is unavailable<a class="headerlink" href="#use-custom-ca-when-let-s-encrypt-is-unavailable" title="Permalink to this headline"></a></h2>
<p>When MARV is deployed on an internal network Let’s Encrypt may not be an option for acquiring server certificates.</p>
<p>You can create a custom certification authority (CA) to properly secure communication with your MARV instance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A simple self-signed certificate will not suffice, as browsers will still classify the connection as insecure without a properly established root of trust.</p>
</div>
<p>In the first step generate a certification authority (CA). You can adjust <code class="docutils literal notranslate"><span class="pre">days</span></code> (validity of CA in days) and <code class="docutils literal notranslate"><span class="pre">subj</span></code> (subject name for certificate) parameters if you like.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">req</span> \
    <span class="o">-</span><span class="n">x509</span> \
    <span class="o">-</span><span class="n">nodes</span> \
    <span class="o">-</span><span class="n">days</span> <span class="mi">1095</span> \
    <span class="o">-</span><span class="n">addext</span> <span class="n">keyUsage</span><span class="o">=</span><span class="s2">&quot;critical,digitalSignature,keyCertSign&quot;</span> \
    <span class="o">-</span><span class="n">addext</span> <span class="n">extendedKeyUsage</span><span class="o">=</span><span class="s2">&quot;serverAuth,clientAuth&quot;</span> \
    <span class="o">-</span><span class="n">subj</span> <span class="s2">&quot;/CN=MarvCA&quot;</span> \
    <span class="o">-</span><span class="n">keyout</span> <span class="n">CA</span><span class="o">-</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">-</span><span class="n">out</span> <span class="n">chain</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">chain.pem</span></code> file needs to be installed on all client machines that are going to interact with MARV.</p>
<p>In the second step generate the server private key and certificate signing request. Again you can adjust the <code class="docutils literal notranslate"><span class="pre">subj</span></code> parameter if you like.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">req</span> \
    <span class="o">-</span><span class="n">new</span> \
    <span class="o">-</span><span class="n">nodes</span> \
    <span class="o">-</span><span class="n">subj</span> <span class="s2">&quot;/CN=MarvServer&quot;</span> \
    <span class="o">-</span><span class="n">keyout</span> <span class="n">privkey</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">-</span><span class="n">out</span> <span class="n">certreq</span><span class="o">.</span><span class="n">csr</span>
</pre></div>
</div>
<p>In the last step generate the server certificate from the certificate signing request. In the example below you can again adjust the <code class="docutils literal notranslate"><span class="pre">days</span></code> parameter to your liking. Be sure to adjust the <code class="docutils literal notranslate"><span class="pre">subjectAltName</span></code> value to match your needs. The value should be a comma separated list of entries starting with <code class="docutils literal notranslate"><span class="pre">IP:</span></code> or <code class="docutils literal notranslate"><span class="pre">DNS:</span></code> and reflect the addresses users will use to access MARV. In most cases a single DNS or IP entry should suffice.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">x509</span> \
    <span class="o">-</span><span class="n">req</span> \
    <span class="o">-</span><span class="n">days</span> <span class="mi">365</span> \
    <span class="o">-</span><span class="n">extfile</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">printf</span> <span class="s2">&quot;</span>
        <span class="n">keyUsage</span><span class="o">=</span><span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span><span class="p">,</span><span class="n">keyEncipherment</span>
        <span class="n">extendedKeyUsage</span><span class="o">=</span><span class="n">serverAuth</span><span class="p">,</span><span class="n">clientAuth</span>
        <span class="n">basicConstraints</span><span class="o">=</span><span class="n">critical</span><span class="p">,</span><span class="n">CA</span><span class="p">:</span><span class="n">FALSE</span>
        <span class="n">subjectKeyIdentifier</span><span class="o">=</span><span class="nb">hash</span>
        <span class="n">authorityKeyIdentifier</span><span class="o">=</span><span class="n">keyid</span><span class="p">,</span><span class="n">issuer</span>
        <span class="n">subjectAltName</span><span class="o">=</span><span class="n">IP</span><span class="p">:</span><span class="mf">192.168.0.42</span><span class="p">,</span><span class="n">DNS</span><span class="p">:</span><span class="n">marv</span><span class="o">.</span><span class="n">internal</span>
    <span class="s2">&quot;) </span><span class="se">\</span>
<span class="s2">    -in certreq.csr </span><span class="se">\</span>
<span class="s2">    -CA chain.pem </span><span class="se">\</span>
<span class="s2">    -CAkey CA-privkey.pem </span><span class="se">\</span>
<span class="s2">    -CAcreateserial </span><span class="se">\</span>
<span class="s2">    -out fullchain.pem</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="upload.html" class="btn btn-neutral float-left" title="Upload (EE)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="accesscontrol.html" class="btn btn-neutral float-right" title="Access Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright  Copyright 2016-2021  Ternaris.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>